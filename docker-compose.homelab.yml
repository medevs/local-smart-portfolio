# =============================================================================
# Docker Compose - Homelab Override (Two-Image Strategy)
# =============================================================================
# This file is for homelab/CI-CD deployments
# - Frontend: pulled from GHCR
# - Backend: built FROM base image (GHCR) + Docling layer (local)
# =============================================================================
# Use with: docker compose -f docker-compose.yml -f docker-compose.homelab.yml up -d
# =============================================================================

services:
  # ===========================================================================
  # Backend Service - Build from GHCR base + Docling
  # ===========================================================================
  # CI pushes backend:base (no Docling) to GHCR
  # Homelab builds FROM base and adds Docling layer
  # ===========================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      args:
        - BASE_IMAGE=ghcr.io/medevs/portfolio-backend:base
        - USE_DOCLING=true

  # ===========================================================================
  # Celery Worker - Build from GHCR base + Docling
  # ===========================================================================
  celery-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
      args:
        - BASE_IMAGE=ghcr.io/medevs/portfolio-backend:base
        - USE_DOCLING=true

  # ===========================================================================
  # Frontend Service - Use GHCR Image
  # ===========================================================================
  # NOTE: NEXT_PUBLIC_API_URL is baked into the image at build time via
  # GitHub Actions (see .github/workflows/deploy.yml). Runtime environment
  # variables for NEXT_PUBLIC_* do NOT work - they must be build args.
  # To change the API URL, update the NEXT_PUBLIC_API_URL secret in GitHub
  # or modify the default in deploy.yml, then trigger a new build.
  # ===========================================================================
  frontend:
    image: ghcr.io/medevs/portfolio-frontend:latest
    build: !reset null
    ports:
      - "3100:3000"
    environment:
      # Only non-NEXT_PUBLIC_* runtime vars work here
      - NEXT_PUBLIC_ADMIN_API_KEY=${ADMIN_API_KEY}
    pull_policy: always

  # ===========================================================================
  # Ollama Init - Inherits from base compose
  # ===========================================================================
  # The ollama-init service from docker-compose.yml handles model pulling.
  # No override needed - it will pull models defined in environment vars.
  # ===========================================================================
